<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LogicMem Pro v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-container { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 2rem; border-radius: 1.5rem; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .card-back { transform: rotateY(180deg); background-color: #f1f5f9; }
        .hidden-view { display: none !important; }
        .modal-overlay { background: rgba(0,0,0,0.5); }
    </style>
    <link rel="icon" href="favicon.png">
</head>
<body class="bg-gray-50 text-slate-800 font-sans h-screen flex flex-col">

    <header class="bg-indigo-700 text-white p-4 shadow-md flex-shrink-0">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-xl">LogicMem Pro</h1>
            <nav class="flex gap-4 text-sm">
                <button onclick="showView('review')" class="opacity-80 hover:opacity-100">復習</button>
                <button onclick="showView('manage')" class="opacity-80 hover:opacity-100">カード管理</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow overflow-hidden relative">
        <div class="max-w-2xl mx-auto h-full p-4 overflow-y-auto">
            
            <div id="view-review" class="view-content h-full flex flex-col">
                <div id="study-area" class="hidden-view flex flex-col h-full">
                    <div class="flex justify-between mb-4">
                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">残り: <span id="due-count">0</span> 枚</span>
                    </div>
                    <div class="card-container flex-grow min-h-[350px] mb-8">
                        <div id="flashcard" class="card-inner cursor-pointer" onclick="toggleFlip()">
                            <div class="card-face text-2xl font-bold text-center whitespace-pre-wrap" id="card-q"></div>
                            <div class="card-face card-back text-xl text-center whitespace-pre-wrap" id="card-a"></div>
                        </div>
                    </div>
                    <div id="action-buttons" class="hidden-view grid grid-cols-3 gap-4 mb-4">
                        <button onclick="processReview(1)" class="bg-red-500 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95">忘れた</button>
                        <button onclick="processReview(3)" class="bg-amber-500 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95">迷った</button>
                        <button onclick="processReview(5)" class="bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95">簡単</button>
                    </div>
                </div>
                <div id="empty-msg" class="text-center py-20 bg-white rounded-3xl shadow-inner border-2 border-dashed">
                    <p class="text-gray-400">今日の復習はすべて完了です！</p>
                </div>
            </div>

            <div id="view-manage" class="view-content hidden-view space-y-4 pb-20">
                <button onclick="openEditModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md">+ 新規カード作成</button>
                <div class="flex justify-between items-center pt-4 border-b pb-2">
                    <h2 class="font-bold text-gray-500 text-sm tracking-widest uppercase">登録済みカード一覧</h2>
                    <span id="total-count" class="text-xs bg-gray-200 px-2 py-1 rounded">0</span>
                </div>
                <div id="card-list" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="hidden-view fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h3 id="modal-title" class="text-lg font-bold mb-4">カードの編集</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 font-bold">問題</label>
                    <textarea id="edit-q" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none h-24"></textarea>
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold">解答</label>
                    <textarea id="edit-a" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none h-24"></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">キャンセル</button>
                    <button onclick="commitSave()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cards = JSON.parse(localStorage.getItem('logicmem_v3_cards') || '[]');
        let currentQueue = [];
        let currentCard = null;

        function saveToStorage() {
            localStorage.setItem('logicmem_v3_cards', JSON.stringify(cards));
            // 【ここに同期処理を追加可能】
        }

        function showView(viewId) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden-view'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden-view');
            if (viewId === 'review') initReview();
            if (viewId === 'manage') renderCardList();
        }

        // --- 復習ロジック (SM-2) ---
        function initReview() {
            const now = new Date();
            currentQueue = cards.filter(c => new Date(c.nextReview) <= now).sort(() => Math.random() - 0.5);
            document.getElementById('due-count').innerText = currentQueue.length;
            if (currentQueue.length > 0) {
                document.getElementById('study-area').classList.remove('hidden-view');
                document.getElementById('empty-msg').classList.add('hidden-view');
                showNextCard();
            } else {
                document.getElementById('study-area').classList.add('hidden-view');
                document.getElementById('empty-msg').classList.remove('hidden-view');
            }
        }

        function showNextCard() {
            if (currentQueue.length === 0) return initReview();
            currentCard = currentQueue[0];
            document.getElementById('card-q').innerText = currentCard.q;
            document.getElementById('card-a').innerText = currentCard.a;
            document.getElementById('flashcard').classList.remove('is-flipped');
            document.getElementById('action-buttons').classList.add('hidden-view');
        }

        function toggleFlip() {
            document.getElementById('flashcard').classList.toggle('is-flipped');
            document.getElementById('action-buttons').classList.remove('hidden-view');
        }

        function processReview(quality) {
            let { interval, repetition, ef } = currentCard;
            if (quality >= 3) {
                if (repetition === 0) interval = 1;
                else if (repetition === 1) interval = 6;
                else interval = Math.round(interval * ef);
                repetition++;
            } else {
                repetition = 0; interval = 1;
            }
            ef = Math.max(1.3, ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
            const nextDate = new Date();
            nextDate.setHours(0,0,0,0);
            nextDate.setDate(nextDate.getDate() + interval);

            const idx = cards.findIndex(c => c.id === currentCard.id);
            cards[idx] = { ...currentCard, interval, repetition, ef, nextReview: nextDate.toISOString() };
            saveToStorage();
            currentQueue.shift();
            document.getElementById('due-count').innerText = currentQueue.length;
            showNextCard();
        }

        // --- 管理・編集ロジック ---
        function renderCardList() {
            const list = document.getElementById('card-list');
            list.innerHTML = '';
            document.getElementById('total-count').innerText = cards.length;
            cards.slice().reverse().forEach(c => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center";
                item.innerHTML = `
                    <div class="flex-grow truncate pr-4">
                        <div class="text-xs text-indigo-500 font-bold mb-1">Q. ${c.q.substring(0, 10)}...</div>
                        <div class="text-sm text-gray-600 truncate">${c.a.substring(0, 20)}...</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModal(${c.id})" class="text-indigo-600 font-bold text-sm bg-indigo-50 px-3 py-1 rounded-lg">編集</button>
                        <button onclick="deleteCard(${c.id})" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">削除</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openEditModal(id = null) {
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            if (id) {
                const card = cards.find(c => c.id === id);
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-q').value = card.q;
                document.getElementById('edit-a').value = card.a;
                title.innerText = "カードの編集";
            } else {
                document.getElementById('edit-id').value = '';
                document.getElementById('edit-q').value = '';
                document.getElementById('edit-a').value = '';
                title.innerText = "新規カード作成";
            }
            modal.classList.remove('hidden-view');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden-view');
        }

        function commitSave() {
            const id = document.getElementById('edit-id').value;
            const q = document.getElementById('edit-q').value.trim();
            const a = document.getElementById('edit-a').value.trim();
            if (!q || !a) return alert("入力してください");

            if (id) {
                const idx = cards.findIndex(c => c.id == id);
                cards[idx].q = q;
                cards[idx].a = a;
            } else {
                cards.push({ id: Date.now(), q, a, interval: 0, repetition: 0, ef: 2.5, nextReview: new Date().toISOString() });
            }
            saveToStorage();
            closeEditModal();
            renderCardList();
        }

        function deleteCard(id) {
            if (confirm("本当に削除しますか？")) {
                cards = cards.filter(c => c.id !== id);
                saveToStorage();
                renderCardList();
            }
        }

        initReview();
    </script>
</body>
</html>


